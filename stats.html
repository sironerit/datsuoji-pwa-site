<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>利用統計 - 脱おじ構文</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://pagead2.googlesyndication.com 'unsafe-inline'; connect-src 'self' https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="脱おじ構文">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="脱おじ構文の利用統計・実績データ。40-50代男性のメッセージ改善効果、利用状況、成功事例を詳細分析。">
    <meta name="keywords" content="利用統計,改善効果,40代,50代,男性向け,メッセージ改善,成功事例,分析データ">
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1 class="logo"><img src="icons/icon-192x192.png" alt="脱おじ構文" class="logo-icon"> 脱おじ構文 - 利用統計</h1>
            <p class="tagline">40-50代男性向け | リアルタイム利用実績・効果分析</p>
        </div>
    </header>

    <!-- Left Sidebar -->
    <aside class="left-sidebar">
        <div class="left-sidebar-content">
            <!-- Navigation Menu -->
            <div class="sidebar-section">
                <h3>📋 機能メニュー</h3>
                <nav class="toc-nav">
                    <a href="./" class="toc-link">💬 メッセージ改善</a>
                    <a href="./analysis.html" class="toc-link">📊 メッセージ分析</a>
                    <a href="./learning.html" class="toc-link">📚 会話術学習</a>
                    <a href="./stats.html" class="toc-link active">📈 利用統計</a>
                </nav>
            </div>
            
            <!-- Quick Tips -->
            <div class="sidebar-section">
                <h3>💡 今日のワンポイント</h3>
                <div class="daily-tip" id="dailyTip">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area with Sidebar -->
    <div class="content-with-sidebar">
        <!-- Main Content -->
        <main class="main">
            <div class="container">
            <!-- Stats Overview Section -->
            <section class="stats-overview-section">
                <div class="stats-header">
                    <h2>📈 脱おじ構文 利用統計・分析データ</h2>
                    <p class="stats-description">
                        40-50代男性向けメッセージ改善サービスの<strong>全体利用実績</strong>と
                        <strong>改善効果データ</strong>をご覧いただけます。<br>
                        <small style="color: #666;">※ 全ユーザーの利用データを集計した統計です</small>
                    </p>
                </div>

                <!-- Main Stats Cards -->
                <div class="main-stats-grid">
                    <div class="stat-card primary-stat">
                        <div class="stat-icon">💬</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalImprovements">0</div>
                            <div class="stat-label">累計改善メッセージ数</div>
                            <div class="stat-trend positive" id="improvementsTrend">本日: <span id="todayCount">0</span>回</div>
                        </div>
                    </div>

                    <div class="stat-card primary-stat">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="successRate">---%</div>
                            <div class="stat-label">AI処理成功率</div>
                            <div class="stat-trend positive" id="successTrend">稼働中</div>
                        </div>
                    </div>

                    <div class="stat-card primary-stat">
                        <div class="stat-icon">📅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="activeDays">0</div>
                            <div class="stat-label">サービス稼働日数</div>
                            <div class="stat-trend positive">継続中</div>
                        </div>
                    </div>

                    <div class="stat-card primary-stat">
                        <div class="stat-icon">🚀</div>
                        <div class="stat-content">
                            <div class="stat-number" id="serviceStartMain">2025.07</div>
                            <div class="stat-label">サービス開始</div>
                            <div class="stat-trend positive">継続改善中</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Usage Patterns Section -->
            <section class="usage-patterns-section">
                <h3>📊 全体利用パターン分析</h3>
                <div class="patterns-grid">
                    <div class="pattern-card">
                        <h4>⏰ 時間帯別利用状況</h4>
                        <div class="time-usage" id="timeUsageChart">
                            <div class="time-slot">
                                <span class="time-label">朝（6-12時）</span>
                                <div class="time-bar" style="height: 0%" id="morningBar"></div>
                                <span class="time-percent" id="morningPercent">0%</span>
                            </div>
                            <div class="time-slot">
                                <span class="time-label">昼（12-18時）</span>
                                <div class="time-bar" style="height: 0%" id="afternoonBar"></div>
                                <span class="time-percent" id="afternoonPercent">0%</span>
                            </div>
                            <div class="time-slot">
                                <span class="time-label">夜（18-24時）</span>
                                <div class="time-bar" style="height: 0%" id="eveningBar"></div>
                                <span class="time-percent" id="eveningPercent">0%</span>
                            </div>
                            <div class="time-slot">
                                <span class="time-label">深夜（0-6時）</span>
                                <div class="time-bar" style="height: 0%" id="nightBar"></div>
                                <span class="time-percent" id="nightPercent">0%</span>
                            </div>
                        </div>
                    </div>

                    <div class="pattern-card">
                        <h4>📊 利用統計情報</h4>
                        <div class="stats-info" id="statsInfo">
                            <div class="info-item">
                                <span class="info-label">総リクエスト数</span>
                                <span class="info-value" id="totalRequests">0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">成功回数</span>
                                <span class="info-value" id="successCount">0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">サービス開始</span>
                                <span class="info-value" id="serviceStart">---</span>
                            </div>
                        </div>
                    </div>

                    <div class="pattern-card">
                        <h4>📈 システム状況</h4>
                        <div class="system-status" id="systemStatus">
                            <div class="status-item">
                                <span class="status-icon">🟢</span>
                                <span class="status-text">AI処理システム稼働中</span>
                            </div>
                            <div class="status-item">
                                <span class="status-icon">📊</span>
                                <span class="status-text">統計データ収集中</span>
                            </div>
                            <div class="status-item">
                                <span class="status-icon">⚡</span>
                                <span class="status-text">高速レスポンス維持</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="page-sidebar">
        <div class="sidebar-content">
            <!-- Direct Products Display (No Categories) -->
            <div class="sidebar-section">
                <h3>🛍️ おすすめ商品</h3>
                <div class="sidebar-products" id="sidebarProducts">
                    <!-- Products will be loaded by shared-products.js -->
                </div>
            </div>
        </div>
        </aside>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 脱おじ構文. All rights reserved.</p>
            <div class="footer-links">
                <a href="privacy.html">プライバシーポリシー</a>
                <a href="terms.html">利用規約</a>
                <a href="contact.html">お問い合わせ</a>
            </div>
        </div>
    </footer>

    
    <!-- Daily Tip Script -->
    <script src="daily-tip.js"></script>
    <script src="shared-products.js"></script>
    <script src="app.js"></script>
    <script>
        // 全体統計データを表示する関数
        async function loadGlobalStats() {
            try {
                const response = await fetch('/.netlify/functions/track-stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'get' })
                });

                if (response.ok) {
                    const stats = await response.json();
                    
                    // 基本統計を更新
                    document.getElementById('totalImprovements').textContent = stats.totalImprovements;
                    document.getElementById('todayCount').textContent = stats.todayCount;
                    
                    // 成功率を表示
                    if (stats.totalRequests > 0) {
                        document.getElementById('successRate').textContent = stats.successRate + '%';
                        document.getElementById('successTrend').textContent = 
                            stats.successRate >= 90 ? '良好' : 
                            stats.successRate >= 70 ? '安定' : '改善中';
                    }
                    
                    // 稼働日数を表示
                    document.getElementById('activeDays').textContent = stats.activeDays;
                    
                    // 時間帯別分析
                    const maxCount = Math.max(
                        stats.timeSlots.morning, 
                        stats.timeSlots.afternoon, 
                        stats.timeSlots.evening, 
                        stats.timeSlots.night
                    );
                    
                    if (maxCount > 0) {
                        document.getElementById('morningBar').style.height = 
                            (stats.timeSlots.morning / maxCount * 100) + '%';
                        document.getElementById('afternoonBar').style.height = 
                            (stats.timeSlots.afternoon / maxCount * 100) + '%';
                        document.getElementById('eveningBar').style.height = 
                            (stats.timeSlots.evening / maxCount * 100) + '%';
                        document.getElementById('nightBar').style.height = 
                            (stats.timeSlots.night / maxCount * 100) + '%';
                        
                        document.getElementById('morningPercent').textContent = 
                            stats.timeSlotPercents.morning + '%';
                        document.getElementById('afternoonPercent').textContent = 
                            stats.timeSlotPercents.afternoon + '%';
                        document.getElementById('eveningPercent').textContent = 
                            stats.timeSlotPercents.evening + '%';
                        document.getElementById('nightPercent').textContent = 
                            stats.timeSlotPercents.night + '%';
                    }
                    
                    // 追加統計情報
                    document.getElementById('totalRequests').textContent = stats.totalRequests;
                    document.getElementById('successCount').textContent = 
                        stats.totalRequests - (stats.totalRequests - stats.totalImprovements);
                    
                    // サービス開始日
                    const startDate = new Date(stats.firstUse);
                    document.getElementById('serviceStart').textContent = 
                        startDate.toLocaleDateString('ja-JP', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    
                    // メイン統計カードのサービス開始も更新
                    const startYearMonth = startDate.getFullYear() + '.' + 
                        String(startDate.getMonth() + 1).padStart(2, '0');
                    document.getElementById('serviceStartMain').textContent = startYearMonth;
                    
                    console.log('📊 全体統計データ表示完了');
                } else {
                    console.error('統計データ取得失敗:', response.status);
                }
                
            } catch (error) {
                console.error('統計データ取得エラー:', error);
                // エラー時は基本的な表示を維持
            }
        }
        
        // ページ読み込み時に統計を更新
        document.addEventListener('DOMContentLoaded', loadGlobalStats);
        
        // 30秒ごとに統計を更新（リアルタイム性を保つ）
        setInterval(loadGlobalStats, 30000);
    </script>
</body>
</html>