<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>利用統計 - 脱おじ構文</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://pagead2.googlesyndication.com 'unsafe-inline'; connect-src 'self' https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="脱おじ構文">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="脱おじ構文の利用統計・実績データ。40-50代男性のメッセージ改善効果、利用状況、成功事例を詳細分析。">
    <meta name="keywords" content="利用統計,改善効果,40代,50代,男性向け,メッセージ改善,成功事例,分析データ">
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1 class="logo"><img src="icons/icon-192x192.png" alt="脱おじ構文" class="logo-icon"> 脱おじ構文 - 利用統計</h1>
            <p class="tagline">40-50代男性向け | リアルタイム利用実績・効果分析</p>
        </div>
    </header>

    <!-- Left Sidebar -->
    <aside class="left-sidebar">
        <div class="left-sidebar-content">
            <!-- Navigation Menu -->
            <div class="sidebar-section">
                <h3>📋 機能メニュー</h3>
                <nav class="toc-nav">
                    <a href="./" class="toc-link">💬 メッセージ改善</a>
                    <a href="./analysis.html" class="toc-link">📊 メッセージ分析</a>
                    <a href="./learning.html" class="toc-link">📚 会話術学習</a>
                    <a href="./stats.html" class="toc-link active">📈 利用統計</a>
                </nav>
            </div>
            
            <!-- Quick Tips -->
            <div class="sidebar-section">
                <h3>💡 今日のワンポイント</h3>
                <div class="daily-tip" id="dailyTip">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area with Sidebar -->
    <div class="content-with-sidebar">
        <!-- Main Content -->
        <main class="main">
            <div class="container">
            <!-- Stats Overview Section -->
            <section class="stats-overview-section">
                <div class="stats-header">
                    <h2>📈 あなたの利用統計・分析データ</h2>
                    <p class="stats-description">
                        あなたの<strong>メッセージ改善利用実績</strong>と
                        <strong>改善効果データ</strong>をご覧いただけます。<br>
                        <small style="color: #666;">※ データはブラウザに保存され、他のユーザーと共有されません</small>
                    </p>
                </div>

                <!-- Main Stats Cards -->
                <div class="main-stats-grid">
                    <div class="stat-card primary-stat">
                        <div class="stat-icon">💬</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalImprovements">0</div>
                            <div class="stat-label">あなたの改善回数</div>
                            <div class="stat-trend positive" id="improvementsTrend">本日: <span id="todayCount">0</span>回</div>
                        </div>
                    </div>

                    <div class="stat-card primary-stat">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="successRate">---%</div>
                            <div class="stat-label">あなたの成功率</div>
                            <div class="stat-trend positive" id="successTrend">稼働中</div>
                        </div>
                    </div>

                    <div class="stat-card primary-stat">
                        <div class="stat-icon">📅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="activeDays">0</div>
                            <div class="stat-label">利用継続日数</div>
                            <div class="stat-trend positive">継続中</div>
                        </div>
                    </div>

                    <div class="stat-card primary-stat">
                        <div class="stat-icon">🚀</div>
                        <div class="stat-content">
                            <div class="stat-number">2025.01</div>
                            <div class="stat-label">サービス開始</div>
                            <div class="stat-trend positive">継続改善中</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Usage Patterns Section -->
            <section class="usage-patterns-section">
                <h3>📊 あなたの利用パターン分析</h3>
                <div class="patterns-grid">
                    <div class="pattern-card">
                        <h4>⏰ 時間帯別利用状況</h4>
                        <div class="time-usage" id="timeUsageChart">
                            <div class="time-slot">
                                <span class="time-label">朝（6-12時）</span>
                                <div class="time-bar" style="height: 0%" id="morningBar"></div>
                                <span class="time-percent" id="morningPercent">0%</span>
                            </div>
                            <div class="time-slot">
                                <span class="time-label">昼（12-18時）</span>
                                <div class="time-bar" style="height: 0%" id="afternoonBar"></div>
                                <span class="time-percent" id="afternoonPercent">0%</span>
                            </div>
                            <div class="time-slot">
                                <span class="time-label">夜（18-24時）</span>
                                <div class="time-bar" style="height: 0%" id="eveningBar"></div>
                                <span class="time-percent" id="eveningPercent">0%</span>
                            </div>
                            <div class="time-slot">
                                <span class="time-label">深夜（0-6時）</span>
                                <div class="time-bar" style="height: 0%" id="nightBar"></div>
                                <span class="time-percent" id="nightPercent">0%</span>
                            </div>
                        </div>
                    </div>

                    <div class="pattern-card">
                        <h4>📊 あなたの利用履歴</h4>
                        <div class="recent-usage" id="recentUsage">
                            <p class="no-data">まだ利用履歴がありません</p>
                        </div>
                    </div>

                    <div class="pattern-card">
                        <h4>📈 あなたの利用傾向</h4>
                        <div class="usage-trends" id="usageTrends">
                            <div class="trend-item">
                                <span class="trend-label">平均利用回数/日</span>
                                <span class="trend-value" id="avgDaily">0回</span>
                            </div>
                            <div class="trend-item">
                                <span class="trend-label">最多利用日</span>
                                <span class="trend-value" id="bestDay">---</span>
                            </div>
                            <div class="trend-item">
                                <span class="trend-label">連続利用日数</span>
                                <span class="trend-value" id="streak">0日</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="page-sidebar">
        <div class="sidebar-content">
            <!-- Direct Products Display (No Categories) -->
            <div class="sidebar-section">
                <h3>🛍️ おすすめ商品</h3>
                <div class="sidebar-products" id="sidebarProducts">
                    <!-- Products will be loaded by shared-products.js -->
                </div>
            </div>
        </div>
        </aside>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 脱おじ構文. All rights reserved.</p>
            <div class="footer-links">
                <a href="privacy.html">プライバシーポリシー</a>
                <a href="terms.html">利用規約</a>
                <a href="contact.html">お問い合わせ</a>
            </div>
        </div>
    </footer>

    
    <!-- Daily Tip Script -->
    <script src="daily-tip.js"></script>
    <script src="shared-products.js"></script>
    <script src="app.js"></script>
    <script>
        // 実際の統計データを表示する関数
        function loadRealStats() {
            // LocalStorageから統計データを取得
            const stats = JSON.parse(localStorage.getItem('datsujoji-stats') || '{}');
            const improvements = stats.improvements || [];
            const successCount = stats.successCount || 0;
            const totalRequests = stats.totalRequests || 0;
            
            // 基本統計を更新
            document.getElementById('totalImprovements').textContent = improvements.length;
            
            // 今日の利用回数を計算
            const today = new Date().toDateString();
            const todayCount = improvements.filter(item => 
                new Date(item.timestamp).toDateString() === today
            ).length;
            document.getElementById('todayCount').textContent = todayCount;
            
            // 成功率を計算
            if (totalRequests > 0) {
                const successRate = Math.round((successCount / totalRequests) * 100);
                document.getElementById('successRate').textContent = successRate + '%';
                document.getElementById('successTrend').textContent = 
                    successRate >= 90 ? '良好' : successRate >= 70 ? '安定' : '改善中';
            }
            
            // 利用日数を計算
            const uniqueDays = [...new Set(improvements.map(item => 
                new Date(item.timestamp).toDateString()
            ))];
            document.getElementById('activeDays').textContent = uniqueDays.length;
            
            // 時間帯別分析
            const timeSlots = { morning: 0, afternoon: 0, evening: 0, night: 0 };
            improvements.forEach(item => {
                const hour = new Date(item.timestamp).getHours();
                if (hour >= 6 && hour < 12) timeSlots.morning++;
                else if (hour >= 12 && hour < 18) timeSlots.afternoon++;
                else if (hour >= 18 && hour < 24) timeSlots.evening++;
                else timeSlots.night++;
            });
            
            const total = improvements.length;
            if (total > 0) {
                const morningPercent = Math.round((timeSlots.morning / total) * 100);
                const afternoonPercent = Math.round((timeSlots.afternoon / total) * 100);
                const eveningPercent = Math.round((timeSlots.evening / total) * 100);
                const nightPercent = Math.round((timeSlots.night / total) * 100);
                
                // 最大値を100%の高さとして正規化
                const maxCount = Math.max(timeSlots.morning, timeSlots.afternoon, timeSlots.evening, timeSlots.night);
                
                if (maxCount > 0) {
                    document.getElementById('morningBar').style.height = (timeSlots.morning / maxCount * 100) + '%';
                    document.getElementById('afternoonBar').style.height = (timeSlots.afternoon / maxCount * 100) + '%';
                    document.getElementById('eveningBar').style.height = (timeSlots.evening / maxCount * 100) + '%';
                    document.getElementById('nightBar').style.height = (timeSlots.night / maxCount * 100) + '%';
                    
                    document.getElementById('morningPercent').textContent = morningPercent + '%';
                    document.getElementById('afternoonPercent').textContent = afternoonPercent + '%';
                    document.getElementById('eveningPercent').textContent = eveningPercent + '%';
                    document.getElementById('nightPercent').textContent = nightPercent + '%';
                }
            }
            
            // 最近の利用履歴（最新5件）
            const recentUsage = document.getElementById('recentUsage');
            if (improvements.length > 0) {
                const recent = improvements.slice(-5).reverse();
                recentUsage.innerHTML = recent.map(item => {
                    const date = new Date(item.timestamp);
                    const timeStr = date.toLocaleString('ja-JP', {
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                    return `<div class="recent-item">${timeStr} - 改善実行</div>`;
                }).join('');
            }
            
            // 利用傾向
            if (uniqueDays.length > 0) {
                const avgDaily = Math.round(improvements.length / uniqueDays.length * 10) / 10;
                document.getElementById('avgDaily').textContent = avgDaily + '回';
                
                // 最多利用日を計算
                const dailyCounts = {};
                improvements.forEach(item => {
                    const day = new Date(item.timestamp).toDateString();
                    dailyCounts[day] = (dailyCounts[day] || 0) + 1;
                });
                
                const bestDayEntry = Object.entries(dailyCounts).reduce((a, b) => 
                    dailyCounts[a[0]] > dailyCounts[b[0]] ? a : b
                );
                const bestDayDate = new Date(bestDayEntry[0]);
                document.getElementById('bestDay').textContent = 
                    bestDayDate.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) + 
                    ' (' + bestDayEntry[1] + '回)';
                
                // 連続利用日数（簡易計算）
                document.getElementById('streak').textContent = uniqueDays.length + '日';
            }
        }
        
        // ページ読み込み時に統計を更新
        document.addEventListener('DOMContentLoaded', loadRealStats);
        
        // 1分ごとに統計を更新（他のページでの利用を反映）
        setInterval(loadRealStats, 60000);
    </script>
</body>
</html>